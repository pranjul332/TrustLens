version: '3.8'

services:
  # ==================== Database ====================
  
  mongodb:
    image: mongo:7
    container_name: mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    environment:
      - MONGO_INITDB_DATABASE=fake_review_platform
    networks:
      - microservices
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ==================== Microservices ====================

  # 1. API Gateway - Port 8000
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-key-change-in-production-please}
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION_HOURS=24
      
      # Rate Limiting
      - RATE_LIMIT_REQUESTS=10
      - RATE_LIMIT_WINDOW=60
      
      # Service URLs
      - URL_CACHE_SERVICE=http://url-cache-service:8001
      - SCRAPER_SERVICE=http://scraper-service:8002
      - NLP_SERVICE=http://nlp-service:8003
      - BEHAVIOR_SERVICE=http://behavior-service:8004
      - SCORING_SERVICE=http://scoring-service:8005
      - REPORT_SERVICE=http://report-service:8006
      
      # CORS
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001
    depends_on:
      mongodb:
        condition: service_healthy
      url-cache-service:
        condition: service_started
      scraper-service:
        condition: service_started
      nlp-service:
        condition: service_started
      behavior-service:
        condition: service_started
      scoring-service:
        condition: service_started
      report-service:
        condition: service_started
    networks:
      - microservices
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s

  # 2. URL Cache Service - Port 8001
  url-cache-service:
    build:
      context: ./url-cache-service
      dockerfile: Dockerfile
    container_name: url-cache-service
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - MONGO_URL=mongodb://mongodb:27017
      - MONGO_DB=fake_review_platform
      - CACHE_TTL_DAYS=7
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 3. Scraper Service - Port 8002
  scraper-service:
    build:
      context: ./scraper-service
      dockerfile: Dockerfile
    container_name: scraper-service
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - MAX_REVIEWS_TO_ANALYZE=150
      - USE_MOCK=true  # Set to false for production scraping
    networks:
      - microservices
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

  # 4. NLP Service - Port 8003
  nlp-service:
    build:
      context: ./nlp-service
      dockerfile: Dockerfile
    container_name: nlp-service
    restart: unless-stopped
    ports:
      - "8003:8003"
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 5. Behavior Service - Port 8004
  behavior-service:
    build:
      context: ./behavior-service
      dockerfile: Dockerfile
    container_name: behavior-service
    restart: unless-stopped
    ports:
      - "8004:8004"
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 6. Scoring Service - Port 8005
  scoring-service:
    build:
      context: ./scoring-service
      dockerfile: Dockerfile
    container_name: scoring-service
    restart: unless-stopped
    ports:
      - "8005:8005"
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 7. Report Service - Port 8006
  report-service:
    build:
      context: ./report-service
      dockerfile: Dockerfile
    container_name: report-service
    restart: unless-stopped
    ports:
      - "8006:8006"
    environment:
      - MONGO_URL=mongodb://mongodb:27017
      - MONGO_DB=fake_review_platform
      - DEFAULT_TTL_DAYS=7
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# ==================== Networks ====================

networks:
  microservices:
    driver: bridge
    name: fake_review_network

# ==================== Volumes ====================

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local